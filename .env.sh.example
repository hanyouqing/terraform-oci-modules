#!/bin/bash

# =============================================================================
# OCI Terraform Modules - Environment Variables Configuration
# =============================================================================
# 
# Copy this file to .env.sh and update with your OCI credentials:
#   cp .env.sh.example .env.sh
#   chmod 600 .env.sh
#   # Edit .env.sh with your values
#   source .env.sh
#
# IMPORTANT: Never commit .env.sh to version control!
# =============================================================================

# -----------------------------------------------------------------------------
# OCI Authentication Configuration
# -----------------------------------------------------------------------------

# OCI Region (must be your home region for Always Free resources)
# Common regions: ap-seoul-1, ap-tokyo-1, ap-singapore-1, us-ashburn-1, us-phoenix-1, eu-frankfurt-1, uk-london-1
export OCI_REGION="${OCI_REGION:-ap-seoul-1}"

# OCI Tenancy OCID (required)
# Find this in: OCI Console -> Administration -> Tenancy Details
export OCI_TENANCY_OCID="${OCI_TENANCY_OCID:-}"

# OCI User OCID (required)
# Find this in: OCI Console -> Identity -> Users -> Your User -> User Details
export OCI_USER_OCID="${OCI_USER_OCID:-}"

# API Key Fingerprint (required)
# Generated when you create an API key pair
# Find this in: OCI Console -> Identity -> Users -> Your User -> API Keys
export OCI_FINGERPRINT="${OCI_FINGERPRINT:-}"

# Path to your private API key file (required)
# This is the private key file (.pem) generated when creating API keys
# Default location: ~/.oci/oci_api_key.pem
export OCI_PRIVATE_KEY_PATH="${OCI_PRIVATE_KEY_PATH:-~/.oci/oci_api_key.pem}"

# Alternative: Use private key content directly (not recommended for security)
# Uncomment and set if you prefer to use key content instead of file path
# export OCI_PRIVATE_KEY="${OCI_PRIVATE_KEY:-}"

# -----------------------------------------------------------------------------
# Terraform Variables (passed to Terraform as TF_VAR_*)
# -----------------------------------------------------------------------------

# Compartment OCID where resources will be created (required)
# Find this in: OCI Console -> Identity -> Compartments
export TF_VAR_compartment_id="${TF_VAR_compartment_id:-}"

# Project name for resource tagging (optional, default: oci-modules)
export TF_VAR_project="${TF_VAR_project:-oci-modules}"

# Environment name for resource tagging (optional, default: development)
# Options: development, testing, staging, production
export TF_VAR_environment="${TF_VAR_environment:-development}"

# Tenancy OCID (if different from OCI_TENANCY_OCID or needed by modules)
export TF_VAR_tenancy_ocid="${TF_VAR_tenancy_ocid:-${OCI_TENANCY_OCID}}"

# Home region for Always Free resources (should match OCI_REGION)
export TF_VAR_home_region="${TF_VAR_home_region:-${OCI_REGION}}"

# Enable Always Free resource validation (optional, default: true)
export TF_VAR_enable_always_free="${TF_VAR_enable_always_free:-true}"

# -----------------------------------------------------------------------------
# Terraform Backend Configuration (Optional)
# -----------------------------------------------------------------------------

# S3-compatible Object Storage bucket for Terraform state
# Format: namespace/bucket-name or just bucket-name
export TF_BACKEND_BUCKET="${TF_BACKEND_BUCKET:-}"

# OCI region for Terraform backend (usually same as OCI_REGION)
export TF_BACKEND_REGION="${TF_BACKEND_REGION:-${OCI_REGION}}"

# State file key/path in the bucket
export TF_BACKEND_KEY="${TF_BACKEND_KEY:-terraform.tfstate}"

# State file encryption key OCID (optional, for encryption at rest)
export TF_BACKEND_ENCRYPTION_KEY="${TF_BACKEND_ENCRYPTION_KEY:-}"

# -----------------------------------------------------------------------------
# OCI Provider Configuration (Advanced)
# -----------------------------------------------------------------------------

# Disable auto-retry for API calls (optional, default: false)
export TF_VAR_disable_auto_retries="${TF_VAR_disable_auto_retries:-false}"

# Retry timeout in seconds (optional, default: 60)
export TF_VAR_retry_duration_seconds="${TF_VAR_retry_duration_seconds:-60}"

# Request timeout in seconds (optional, default: 60)
export TF_VAR_request_timeout="${TF_VAR_request_timeout:-60}"

# -----------------------------------------------------------------------------
# Module-Specific Variables (Optional)
# -----------------------------------------------------------------------------

# VCN Configuration
export TF_VAR_vcn_cidr_blocks="${TF_VAR_vcn_cidr_blocks:-10.0.0.0/16}"

# Compute Configuration
export TF_VAR_compute_shape="${TF_VAR_compute_shape:-VM.Standard.E2.1.Micro}"
export TF_VAR_compute_count="${TF_VAR_compute_count:-1}"

# Storage Configuration
export TF_VAR_block_volume_size_gb="${TF_VAR_block_volume_size_gb:-50}"
export TF_VAR_object_storage_tier="${TF_VAR_object_storage_tier:-Standard}"

# Database Configuration
export TF_VAR_database_admin_password="${TF_VAR_database_admin_password:-}"

# -----------------------------------------------------------------------------
# Terraform Configuration
# -----------------------------------------------------------------------------

# Terraform log level (optional)
# Options: TRACE, DEBUG, INFO, WARN, ERROR
export TF_LOG="${TF_LOG:-}"

# Terraform log path (optional)
export TF_LOG_PATH="${TF_LOG_PATH:-}"

# Terraform parallelism (optional, default: 10)
export TF_PARALLELISM="${TF_PARALLELISM:-10}"

# -----------------------------------------------------------------------------
# Validation and Helpers
# -----------------------------------------------------------------------------

# Function to validate required OCI credentials
validate_oci_credentials() {
  local missing_vars=()
  
  [ -z "$OCI_TENANCY_OCID" ] && missing_vars+=("OCI_TENANCY_OCID")
  [ -z "$OCI_USER_OCID" ] && missing_vars+=("OCI_USER_OCID")
  [ -z "$OCI_FINGERPRINT" ] && missing_vars+=("OCI_FINGERPRINT")
  [ -z "$TF_VAR_compartment_id" ] && missing_vars+=("TF_VAR_compartment_id")
  
  if [ -z "$OCI_PRIVATE_KEY" ] && [ ! -f "${OCI_PRIVATE_KEY_PATH/#\~/$HOME}" ]; then
    missing_vars+=("OCI_PRIVATE_KEY_PATH (file not found)")
  fi
  
  if [ ${#missing_vars[@]} -gt 0 ]; then
    echo "ERROR: Missing required environment variables:"
    printf '  - %s\n' "${missing_vars[@]}"
    echo ""
    echo "Please set these variables in .env.sh"
    return 1
  fi
  
  echo "âœ“ All required OCI credentials are set"
  return 0
}

# Function to display current configuration (without sensitive data)
show_config() {
  echo "OCI Configuration:"
  echo "  Region: ${OCI_REGION}"
  echo "  Tenancy OCID: ${OCI_TENANCY_OCID:0:20}..."
  echo "  User OCID: ${OCI_USER_OCID:0:20}..."
  echo "  Fingerprint: ${OCI_FINGERPRINT:0:20}..."
  echo "  Private Key Path: ${OCI_PRIVATE_KEY_PATH}"
  echo ""
  echo "Terraform Variables:"
  echo "  Compartment ID: ${TF_VAR_compartment_id:0:20}..."
  echo "  Project: ${TF_VAR_project}"
  echo "  Environment: ${TF_VAR_environment}"
  echo "  Home Region: ${TF_VAR_home_region}"
  echo ""
  if [ -n "$TF_BACKEND_BUCKET" ]; then
    echo "Terraform Backend:"
    echo "  Bucket: ${TF_BACKEND_BUCKET}"
    echo "  Region: ${TF_BACKEND_REGION}"
    echo "  Key: ${TF_BACKEND_KEY}"
  fi
}

# Auto-validate on source (optional, comment out if not desired)
# validate_oci_credentials
